<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terms & Conditions - Kings Equestrian</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, <?= colors.primary ?> 0%, <?= colors.accent ?> 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, <?= colors.primary ?> 0%, <?= colors.accent ?> 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }
    
    .header img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 15px;
      border: 3px solid white;
    }
    
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.95;
    }
    
    .content {
      padding: 40px 30px;
    }
    
    .user-info {
      background: <?= colors.background ?>;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border-left: 4px solid <?= colors.secondary ?>;
    }
    
    .user-info p {
      margin: 8px 0;
      font-size: 16px;
    }
    
    .user-info strong {
      color: <?= colors.primary ?>;
    }
    
    .terms-section {
      margin: 30px 0;
    }
    
    .terms-section h2 {
      color: <?= colors.primary ?>;
      font-size: 24px;
      margin-bottom: 15px;
      border-bottom: 3px solid <?= colors.secondary ?>;
      padding-bottom: 10px;
    }
    
    .terms-box {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 25px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 25px;
    }
    
    .terms-box::-webkit-scrollbar {
      width: 8px;
    }
    
    .terms-box::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .terms-box::-webkit-scrollbar-thumb {
      background: <?= colors.secondary ?>;
      border-radius: 10px;
    }
    
    .terms-box h3 {
      color: <?= colors.primary ?>;
      font-size: 18px;
      margin: 20px 0 10px 0;
    }
    
    .terms-box h3:first-child {
      margin-top: 0;
    }
    
    .terms-box ul {
      margin: 10px 0 15px 25px;
    }
    
    .terms-box li {
      margin: 8px 0;
      color: #333;
    }
    
    .terms-box p {
      margin: 10px 0;
      color: #555;
    }
    
    .consent-checkbox {
      background: <?= colors.background ?>;
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      border: 2px solid <?= colors.primary ?>;
    }
    
    .consent-checkbox label {
      display: flex;
      align-items: flex-start;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
    }
    
    .consent-checkbox input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 15px;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .button-container {
      text-align: center;
      margin: 30px 0;
    }
    
    .submit-button {
      background: linear-gradient(135deg, <?= colors.primary ?> 0%, <?= colors.accent ?> 100%);
      color: white;
      border: none;
      padding: 18px 50px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .submit-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .submit-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .success-message {
      display: none;
      background: #d4edda;
      color: #155724;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      margin: 30px 0;
      border: 2px solid #c3e6cb;
    }
    
    .success-message h2 {
      color: #155724;
      margin-bottom: 15px;
    }
    
    .success-message .reg-number {
      font-size: 32px;
      font-weight: bold;
      color: <?= colors.primary ?>;
      margin: 20px 0;
      letter-spacing: 2px;
    }
    
    .success-message .payment-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .already-registered {
      display: none;
      background: #fff3cd;
      color: #856404;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      margin: 30px 0;
      border: 2px solid #ffeaa7;
    }
    
    .already-registered h2 {
      color: #856404;
      margin-bottom: 15px;
    }
    
    .error-message {
      display: none;
      background: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 2px solid #f5c6cb;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid <?= colors.primary ?>;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .footer {
      background: <?= colors.primary ?>;
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .header {
        padding: 30px 20px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .content {
        padding: 25px 20px;
      }
      
      .terms-box {
        max-height: 300px;
      }
      
      .submit-button {
        padding: 15px 35px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <img src="https://kingsfarmequestrian.com/wp-content/uploads/2023/08/Logo2.jpg" alt="Kings Equestrian Logo">
      <h1>KINGS EQUESTRIAN</h1>
      <p>Terms & Conditions Agreement</p>
    </div>
    
    <!-- Content -->
    <div class="content">
      <!-- User Information -->
      <div class="user-info">
        <p><strong>Name:</strong> <?= name ?></p>
        <p><strong>Email:</strong> <?= email ?></p>
        <p><strong>Location:</strong> <?= location ?></p>
      </div>
      
      <!-- Terms & Conditions -->
      <div class="terms-section">
        <h2>üìã Terms & Conditions</h2>
        
        <!-- ‚úÖ DYNAMIC CONTENT FROM GOOGLE DOCS -->
        <div class="terms-box">
          <?!= termsHtml ?>
        </div>
      </div>
      
      <!-- Consent Checkbox -->
      <div class="consent-checkbox">
        <label>
          <input type="checkbox" id="consentCheckbox">
          <span>
            I have read and understood all the Terms & Conditions stated above. 
            I agree to abide by these terms and accept full responsibility for my 
            participation in Kings Equestrian activities. I acknowledge that 
            horseback riding involves inherent risks and I voluntarily assume those risks.
          </span>
        </label>
      </div>
      
      <!-- Submit Button -->
      <div class="button-container">
        <button class="submit-button" id="submitButton" disabled onclick="submitConsent()">
          I Accept - Complete Registration
        </button>
      </div>
      
      <!-- Loading -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: <?= colors.primary ?>;">Processing your acceptance...</p>
      </div>
      
      <!-- Error Message -->
      <div class="error-message" id="errorMessage"></div>
      
      <!-- Already Registered Message -->
      <div class="already-registered" id="alreadyRegistered">
        <h2>‚ö†Ô∏è Already Registered</h2>
        <p id="alreadyRegisteredMessage"></p>
        <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px;">
          <p><strong>Your Registration Number:</strong></p>
          <p style="font-size: 24px; font-weight: bold; color: <?= colors.primary ?>; margin: 10px 0;" id="existingRegNumber"></p>
          <!-- <p style="margin-top: 10px;"><strong>Payment Status:</strong> <span id="existingPaymentStatus"></span></p> -->
        </div>
      </div>
      
      <!-- Success Message -->
      <div class="success-message" id="successMessage">
        <h2>‚úÖ Registration Confirmed!</h2>
        <p>Thank you for accepting our Terms & Conditions.</p>
        
        <div class="reg-number" id="regNumber"></div>
        
        <div class="payment-box">
          <p><strong>Payment request has been sent to your email</strong></p>
          <!-- <p style="font-size: 20px; color: <?= colors.primary ?>;">
            Amount: ‚Çπ<span id="paymentAmount"></span>
          </p> -->
        </div>
        
        <p style="margin-top: 20px; font-size: 14px; color: #666;">
          Please check your email for payment details.
        </p>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p style="font-weight: 600; font-size: 16px;">KINGS EQUESTRIAN</p>
      <p style="margin-top: 10px;">üìû 9980771166 | 9980895533</p>
      <p>‚úâÔ∏è info@kingsequestrian.com</p>
      <p style="margin-top: 15px; font-size: 12px;">
        ¬© <?= new Date().getFullYear() ?> Kings Equestrian. All rights reserved.
      </p>
    </div>
  </div>
  
<script>
  // Enable submit button when checkbox is checked
  document.getElementById('consentCheckbox').addEventListener('change', function () {
    document.getElementById('submitButton').disabled = !this.checked;
  });

  async function submitConsent() {
  if (!document.getElementById('consentCheckbox').checked) {
    alert('Please accept the Terms & Conditions to proceed.');
    return;
  }
  console.log("Consent accepted");

  document.getElementById('loading').style.display = 'block';
  document.getElementById('submitButton').style.display = 'none';
  document.getElementById('errorMessage').style.display = 'none';

  const data = {
    name: '<?= name ?>',
    email: '<?= email ?>',
    location: '<?= location ?>',
    consentAccepted: true
  };

  console.log('Sending data:', data);

  try {
    // ‚úÖ Use google.script.run - calls server function directly
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .submitConsentToServer(data);  // Your server function name
    });

    console.log('Server response:', result);
    handleSuccess(result);
  } catch (error) {
    console.error('Error:', error);
    handleFailure(error);
  } finally {
    // Show button again on error
    document.getElementById('submitButton').style.display = 'inline-block';
    document.getElementById('loading').style.display = 'none';
  }
}


  function handleSuccess(result) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('submitButton').style.display = 'none';

    if (result.success) {
      document.querySelector('.user-info').style.display = 'none';
      document.querySelector('.terms-section').style.display = 'none';
      document.querySelector('.consent-checkbox').style.display = 'none';

      document.getElementById('regNumber').textContent =
        'Registration No #: ' + result.registrationNumber;

      // Note: You need to add paymentLink to your submitConsentToServer response
      if (result.paymentLink) {
        document.getElementById('paymentLink').href = result.paymentLink;
      }

      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('successMessage')
        .scrollIntoView({ behavior: 'smooth' });
        
    } else if (result.alreadyRegistered) {
      document.querySelector('.user-info').style.display = 'none';
      document.querySelector('.terms-section').style.display = 'none';
      document.querySelector('.consent-checkbox').style.display = 'none';
      
      document.getElementById('alreadyRegisteredMessage').textContent = result.message;
      document.getElementById('existingRegNumber').textContent = result.details.registrationNumber;
      document.getElementById('existingPaymentStatus').textContent = result.details.paymentStatus;
      document.getElementById('alreadyRegistered').style.display = 'block';
      
      document.getElementById('alreadyRegistered').scrollIntoView({ behavior: 'smooth' });
      
    } else {
      showError(result.message);
    }
  }

  function handleFailure(error) {
    console.error(error);
    showError('Server error. Please try again.');
  }

  function showError(msg) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorMessage').textContent = '‚ùå ' + msg;
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('submitButton').style.display = 'inline-block';
  }
</script>

</body>
</html>